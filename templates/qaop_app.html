{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/qaop_app.css') }}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<div class="dashboard-container" 
     data-mies="{{ mie_query if mie_query is defined else '' }}" 
     data-qid="{{ qid if qid is defined else '' }}" 
     data-qid-wd="{{ qid_wd if qid_wd is defined else '' }}"
     data-title="{{ title if title is defined else 'AOP Network Builder' }}"
     id="compound-container">
    <!-- Top Navigation Bar -->
    <header class="top-nav">
        <div class="nav-section">
            <button id="toggle-left-sidebar" class="sidebar-toggle btn-secondary">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-project-diagram"></i> {{ title if title is defined else 'AOP Network Builder' }}</h1>
        </div>
        <div class="nav-controls">
            <div class="control-group">
                <label>Font Size:</label>
                <input type="range" id="font-size-slider" min="0.1" max="1" step=".1" value="0.5" class="slider">
            </div>
            <button id="save_network" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Network
            </button>
            <button id="load_network" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Load Network
            </button>
            <button id="toggle-right-sidebar" class="sidebar-toggle btn-secondary">
                <i class="fas fa-table"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Left Sidebar -->
        <aside class="left-sidebar" id="left-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cog"></i> Controls</h3>
                <button class="sidebar-close" data-target="left-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Data Sources Section -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-database"></i> Data Sources</h3>
                </div>
                <div class="panel-content">
                    <select id="data-type-dropdown" class="form-select" onchange="handleDataTypeChange()">
                        <option value="qsprpred_opt">QSPRPred</option>
                        <option value="bdf_opt">BioDataFuse</option>
                        <option value="custom_table_opt">Custom Tables</option>
                    </select>
                    
                    <div id="qsprpred" class="data-section">
                        <button id="fetch_predictions" class="btn btn-primary w-100">
                            <i class="fas fa-chart-line"></i> Get QSPR Predictions
                        </button>
                        <div class="form-group">
                            <label for="threshold_pchembl">pChEMBL Threshold:</label>
                            <input type="number" step="0.1" class="form-control" id="threshold_pchembl" value="6.5">
                            <small class="form-text">Activity of 10<sup id="activity_display">-6.5</sup> M</small>
                        </div>
                        <button id="fetch_predictions" class="btn btn-primary">
                            <i class="fas fa-flask"></i> Fetch Predictions
                        </button>
                    </div>
                    
                    <div id="bdf_div" class="data-section">
                        <button id="query_opentargets" class="btn btn-secondary">
                            <i class="fas fa-bullseye"></i> Query OpenTargets
                        </button>
                        <button id="query_bgee" class="btn btn-secondary">
                            <i class="fas fa-dna"></i> Query Bgee
                        </button>
                    </div>
                    
                    <div id="custom_table_div" class="data-section">
                        <div class="form-group">
                            <label for="upload-table-file">Upload CSV/TSV:</label>
                            <input type="file" id="upload-table-file" accept=".csv,.tsv,.txt" class="form-control">
                            <div id="table-upload-status" class="mt-2"></div>
                        </div>
                        <div class="form-group">
                            <label for="uploaded-tables-select">Select Table:</label>
                            <select id="uploaded-tables-select" class="form-control"></select>
                        </div>
                        <button id="map-table-btn" class="btn btn-primary" disabled>
                            <i class="fas fa-map"></i> Map to Network
                        </button>
                        <div id="table-preview" class="mt-3"></div>
                    </div>
                    
                    <div id="qaop_div" class="data-section">
                        <div id="loading_qaop_table" class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading QAOP data...
                        </div>
                        <div class="table-wrapper">
                            <table id="qaop_table" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th>Relationship</th>
                                        <th>Target</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Data Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-plus-circle"></i> Add Data Manually</h3>
                </div>
                <div class="panel-content">
                    <!-- Add Nodes Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="add-nodes-content">
                            <h4><i class="fas fa-circle"></i> Add Nodes</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="add-nodes-content">
                            <div class="node-controls">
                                <div class="form-group">
                                    <label for="node-type">Node Type:</label>
                                    <select id="node-type" class="form-control">
                                        <option value="ke">Key Event</option>
                                        <option value="chemical">Chemical</option>
                                        <option value="uniprot">UniProt</option>
                                        <option value="ensembl">Ensembl</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="node-label">Node Label:</label>
                                    <input type="text" id="node-label" class="form-control" placeholder="Enter node label">
                                </div>
                                <div class="form-group">
                                    <label for="node-id">Node ID (optional):</label>
                                    <input type="text" id="node-id" class="form-control" placeholder="Auto-generated if empty">
                                </div>
                                <button id="add-node" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Add Node
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Add Edges Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="add-edges-content">
                            <h4><i class="fas fa-link"></i> Add Edges</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="add-edges-content">
                            <div class="connection-controls">
                                <div class="form-group">
                                    <label for="source-node">Source Node:</label>
                                    <div class="searchable-dropdown">
                                        <input type="text" id="source-node-search" class="form-control dropdown-search" placeholder="Search source nodes...">
                                        <select id="source-node" class="form-control searchable-select" size="5">
                                            <option value="">Select source...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="target-node">Target Node:</label>
                                    <div class="searchable-dropdown">
                                        <input type="text" id="target-node-search" class="form-control dropdown-search" placeholder="Search target nodes...">
                                        <select id="target-node" class="form-control searchable-select" size="5">
                                            <option value="">Select target...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="edge-type">Connection Type:</label>
                                    <select id="edge-type" class="form-control">
                                        <option value="ker">Key Event Relationship</option>
                                        <option value="interaction">Interaction</option>
                                        <option value="part_of">Part Of</option>
                                        <option value="translates_to">Translates To</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edge-label">Connection Label (optional):</label>
                                    <input type="text" id="edge-label" class="form-control" placeholder="Enter connection label">
                                </div>
                                <button id="add-connection" class="btn btn-success">
                                    <i class="fas fa-link"></i> Add Edge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AOP Network Data Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-network-wired"></i> Add AOP Network Data</h3>
                </div>
                <div class="panel-content">
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="aop-network-content">
                            <h4><i class="fas fa-plus-circle"></i> Add More Network Data</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="aop-network-content">
                            <div class="aop-network-controls">
                                <div class="form-group">
                                    <label for="query-type">Query Type:</label>
                                    <select id="query-type" class="form-control">
                                        <option value="mie">Add by MIE</option>
                                        <option value="aop">Add by AOP</option>
                                        <option value="ke_upstream">Add by Upstream KE</option>
                                        <option value="ke_downstream">Add by Downstream KE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="query-values">Values (space-separated URIs):</label>
                                    <textarea id="query-values" class="form-control" rows="3" 
                                             placeholder="Enter space-separated URIs or identifiers (e.g., 1 2 3 or https://identifiers.org/aop.events/1)"></textarea>
                                    <small class="form-text">
                                        Examples:<br>
                                        • Full URIs: https://identifiers.org/aop.events/1 https://identifiers.org/aop.events/2<br>
                                        • Short form: 1 2 3<br>
                                        • Prefixed: aop.events:1 aop.events:2
                                    </small>
                                </div>
                                <button id="add-aop-data" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add to Network
                                </button>
                                <div id="aop-data-status" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center Network Area -->
        <main class="network-area">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-project-diagram"></i> Network Visualization</h3>
                    <div class="network-controls">
                        <button id="see_genes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-dna"></i> See Genes
                        </button>
                        <button id="toggle_bounding_boxes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-object-group"></i> Group by AOP
                        </button>
                        <button id="reset_layout" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync"></i> Reset Layout
                        </button>
                        <button id="download_network" class="btn btn-sm btn-secondary">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="panel-content network-container">
                    <div class="loading-overlay">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-3x"></i>
                            <p>Loading network...</p>
                        </div>
                    </div>
                    <div id="cy"></div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar" id="right-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-table"></i> Data Tables</h3>
                <button class="sidebar-close" data-target="right-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Compounds Table -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-flask"></i> Compounds</h3>
                    <div class="compound-controls">
                        <button id="toggle_compounds" class="btn btn-sm btn-secondary">
                            <i class="fas fa-flask"></i> Toggle Compounds
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="compound-selection-hint">
                        <p>Click compound rows to show their pathways in the network</p>
                    </div>
                    <div class="table-wrapper">
                        <div id="loading_compound" class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading compounds...
                        </div>
                        <table id="compound_table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Compound</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Genes Table - Always visible -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-dna"></i> Genes</h3>
                </div>
                <div class="panel-content">
                    <div class="table-wrapper">
                        <table id="gene_table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Gene</th>
                                    <th>Expression</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Table Mapping Modal -->
<div class="modal fade" id="table-mapping-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Map Table to Network</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Node Creation</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="create-nodes-checkbox">
                            <label class="form-check-label" for="create-nodes-checkbox">Create nodes from table</label>
                        </div>
                        <div class="form-group">
                            <label for="node-type-select">Node Type:</label>
                            <select id="node-type-select" class="form-control">
                                <option value="ke">Key Event</option>
                                <option value="chemical">Chemical</option>
                                <option value="uniprot">UniProt</option>
                                <option value="ensembl">Ensembl</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="node-id-column">ID Column:</label>
                            <select id="node-id-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="node-label-column">Label Column:</label>
                            <select id="node-label-column" class="form-control"></select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Edge Creation</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="create-edges-checkbox">
                            <label class="form-check-label" for="create-edges-checkbox">Create edges from table</label>
                        </div>
                        <div class="form-group">
                            <label for="edge-type-select">Edge Type:</label>
                            <select id="edge-type-select" class="form-control">
                                <option value="ker">Key Event Relationship</option>
                                <option value="interaction">Interaction</option>
                                <option value="part_of">Part Of</option>
                                <option value="translates_to">Translates To</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edge-source-column">Source Column:</label>
                            <select id="edge-source-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="edge-target-column">Target Column:</label>
                            <select id="edge-target-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="edge-label-column">Label Column:</label>
                            <select id="edge-label-column" class="form-control"></select>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Property Columns</h6>
                        <div id="property-columns">
                            <!-- Dynamically populated checkboxes -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-mapping-btn">Apply Mapping</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let compound_data = {};
    let compoundMapping = {};
    let modelToProteinInfo = {};
    let fetched_preds = false;
    let genesVisible = false;
    let boundingBoxesVisible = false;
    let compoundsVisible = false;

    // Make sure cy is available globally from the start
    window.cy = null;

    // Update activity display
    function updateActivity() {
        const value = document.getElementById('threshold_pchembl').value;
        document.getElementById('activity_display').textContent = `-${value}`;
    }
    
    // Only add event listener if element exists
    const thresholdInput = document.getElementById('threshold_pchembl');
    if (thresholdInput) {
        thresholdInput.addEventListener('input', updateActivity);
    }

    // Sidebar collapse functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle buttons in nav
        document.getElementById('toggle-left-sidebar')?.addEventListener('click', function() {
            toggleSidebar('left-sidebar');
        });
        
        document.getElementById('toggle-right-sidebar')?.addEventListener('click', function() {
            toggleSidebar('right-sidebar');
        });
        
        // Close buttons in sidebars
        document.querySelectorAll('.sidebar-close').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                toggleSidebar(targetId);
            });
        });
    });

    function toggleSidebar(sidebarId) {
        const sidebar = document.getElementById(sidebarId);
        if (!sidebar) return;
        
        sidebar.classList.toggle('collapsed');
        
        // Trigger resize event for Cytoscape to adjust
        setTimeout(() => {
            if (window.cy) {
                window.cy.resize();
                if (window.positionNodes) {
                    window.positionNodes(window.cy);
                }
            }
        }, 300);
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.js"></script>

<script src="/static/js/aop_app/aop_elements.js"></script>
<script src="/static/js/aop_app/aop_styles.js"></script>
<script src="/static/js/aop_app/qsprpred.js"></script>
<script src="/static/js/aop_app/select_data.js"></script>
<script src="/static/js/aop_app/compound.js"></script>
<script src="/static/js/aop_app/gene.js"></script>
<script src="/static/js/aop_app/bdf.js"></script>
<script src="/static/js/aop_app/network_persistence.js"></script>
<script src="/static/js/aop_app/manual_controls.js"></script>
<script src="/static/js/aop_app/custom_tables.js"></script>
<script src="/static/js/aop_app/table_qaop.js"></script>
<script src="/static/js/aop_app/aop_network_data.js"></script>

{% endblock %}
