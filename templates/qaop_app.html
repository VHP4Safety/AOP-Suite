{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/qaop_app.css') }}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<div class="dashboard-container" 
     data-mies="{{ mie_query if mie_query is defined else mies if mies is defined else '' }}" 
     data-qid="{{ qid if qid is defined else '' }}" 
     data-qid-wd="{{ qid_wd if qid_wd is defined else '' }}"
     data-title="{{ title if title is defined else '' }}"
     id="compound-container">
    <!-- Top Navigation Bar -->
    <header class="top-nav">
        <div class="nav-section">
            <h1><i class="fas fa-project-diagram"></i> {{ title if title is defined else 'AOP Network Builder' }}</h1>
        </div>
        <div class="nav-controls">
            <div class="control-group">
                <label>Font Size:</label>
                <input type="range" id="font-size-slider" min="0.1" max="1" step=".1" value="0.5" class="slider">
            </div>
            <button id="save_network" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Network
            </button>
            <button id="load_network" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Load Network
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <!-- Data Sources Section -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-database"></i> Data Sources</h3>
                </div>
                <div class="panel-content">
                    <select id="data-type-dropdown" class="form-select" onchange="handleDataTypeChange()">
                        <option value="qsprpred_opt">QSPRPred</option>
                        <option value="qaop_opt">Custom qAOP data</option>
                        <option value="bdf_opt">BioDataFuse</option>
                    </select>
                    
                    <div id="qsprpred" class="data-section">
                        <button id="fetch_predictions" class="btn btn-primary w-100">
                            <i class="fas fa-chart-line"></i> Get QSPR Predictions
                        </button>
                        <div class="form-group">
                            <label for="threshold_pchembl">pChEMBL Threshold:</label>
                            <input type="number" step="0.1" class="form-control" id="threshold_pchembl" value="6.5">
                            <small class="form-text">Activity of 10<sup id="activity_display">-6.5</sup> M</small>
                        </div>
                    </div>
                    
                    <div id="qaop_div" class="data-section" style="display: none;">
                        <div class="table-wrapper">
                            <table class="table" id="qaop_table"> 
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th>KER</th>
                                        <th>Target</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="loading-row">
                                        <td colspan="3" class="text-center">Loading AOP network...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="bdf_div" class="data-section" style="display: none;">
                        <button id="query_opentargets" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-pills"></i> Query OpenTargets
                        </button>
                        <button id="query_bgee" class="btn btn-primary w-100">
                            <i class="fas fa-dna"></i> Query Bgee
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Node Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-plus-circle"></i> Add Nodes</h3>
                </div>
                <div class="panel-content">
                    <div class="node-controls">
                        <div class="form-group">
                            <label for="node-type">Node Type:</label>
                            <select id="node-type" class="form-select">
                                <option value="ke">Key Event</option>
                                <option value="chemical">Chemical</option>
                                <option value="uniprot">UniProt</option>
                                <option value="ensembl">Ensembl</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="node-label">Label:</label>
                            <input type="text" id="node-label" class="form-control" placeholder="Enter node label">
                        </div>
                        <div class="form-group">
                            <label for="node-id">ID (optional):</label>
                            <input type="text" id="node-id" class="form-control" placeholder="Auto-generated if empty">
                        </div>
                        <button id="add-node" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> Add Node
                        </button>
                    </div>
                </div>
            </div>

            <!-- Connection Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-link"></i> Add Connections</h3>
                </div>
                <div class="panel-content">
                    <div class="connection-controls">
                        <div class="form-group">
                            <label for="source-node">Source Node:</label>
                            <select id="source-node" class="form-select">
                                <option value="">Select source...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="target-node">Target Node:</label>
                            <select id="target-node" class="form-select">
                                <option value="">Select target...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edge-type">Connection Type:</label>
                            <select id="edge-type" class="form-select">
                                <option value="ker">Key Event Relationship</option>
                                <option value="interaction">Interaction</option>
                                <option value="part_of">Part Of</option>
                                <option value="translates_to">Translates To</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edge-label">Label (optional):</label>
                            <input type="text" id="edge-label" class="form-control" placeholder="Connection label">
                        </div>
                        <button id="add-connection" class="btn btn-success w-100">
                            <i class="fas fa-arrow-right"></i> Add Connection
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center Network Area -->
        <main class="network-area">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-project-diagram"></i> Network Visualization</h3>
                    <div class="network-controls">
                        <button id="reset_layout" class="btn btn-sm btn-secondary">
                            <i class="fas fa-refresh"></i> Reset Layout
                        </button>
                        <button id="see_genes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-dna"></i> See Genes
                        </button>
                        <button id="toggle_compounds" class="btn btn-sm btn-secondary">
                            <i class="fas fa-flask"></i> Show Compounds
                        </button>
                        <button id="toggle_bounding_boxes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-object-group"></i> Group by AOP
                        </button>
                        <button id="download_network" class="btn btn-sm btn-primary">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="panel-content network-container">
                    <div id="cy">
                        <div class="loading-overlay">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading AOP network...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <!-- Compounds Table -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-flask"></i> Compounds</h3>
                </div>
                <div class="panel-content">
                    <div class="table-wrapper">
                        <table class="table" id="compound_table">
                            <thead>
                                <tr>
                                    <th>Compound</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="loading-row">
                                    <td class="text-center">Loading compounds...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Genes Table - Always visible -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-dna"></i> Genes</h3>
                </div>
                <div class="panel-content">
                    <div class="table-wrapper">
                        <table class="table" id="gene_table">
                            <thead>
                                <tr>
                                    <th>Gene</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="loading-row">
                                    <td class="text-center">Loading genes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    // Global variables
    let compound_data = {};
    let compoundMapping = {};
    let modelToProteinInfo = {};
    let fetched_preds = false;
    let genesVisible = false;
    let boundingBoxesVisible = false;
    let compoundsVisible = false;

    // Make sure cy is available globally from the start
    window.cy = null;

    // Update activity display
    function updateActivity() {
        const value = document.getElementById('threshold_pchembl').value;
        document.getElementById('activity_display').textContent = `-${value}`;
    }
    
    // Only add event listener if element exists
    const thresholdInput = document.getElementById('threshold_pchembl');
    if (thresholdInput) {
        thresholdInput.addEventListener('input', updateActivity);
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.js"></script>

<script src="/static/js/aop_app/aop_elements.js"></script>
<script src="/static/js/aop_app/aop_styles.js"></script>
<script src="/static/js/aop_app/qsprpred.js"></script>
<script src="/static/js/aop_app/select_data.js"></script>
<script src="/static/js/aop_app/compound.js"></script>
<script src="/static/js/aop_app/gene.js"></script>
<script src="/static/js/aop_app/bdf.js"></script>
<script src="/static/js/aop_app/network_persistence.js"></script>
<script src="/static/js/aop_app/manual_controls.js"></script>

{% endblock %}
