{% extends "base.html" %} {% block content %}

<!-- Include DataTables CSS and JS -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"
/>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<h1>Thyroid Case Demo Workflow for the Hackathon</h1>
<br />

<div class="container">
  <section>
    <p>Select compounds from the table:</p>
    <table class="table table-bordered table-striped" id="compound_table">
      <thead>
        <tr>
          <th>Select</th>
          <th>Compound</th>
          <th>SMILES</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Service Selection Section -->
    <div class="container">
      <p>Select services to run:</p>
      <div id="service_selection">
        <label
          ><input
            type="checkbox"
            class="service-checkbox"
            value="QSPR"
            id="qspr_checkbox"
          />
          QSPR</label
        ><br />
        <label
          ><input
            type="checkbox"
            class="service-checkbox"
            value="SOMpredictor"
            id="sompredictor_checkbox"
          />
          SOMpredictor</label
        >
      </div>
    </div>

    <!-- QSPR Section -->
    <div id="qspr_section" class="service-section">
      <h3>QSPR Service</h3>
      <p>Select models to use:</p>
      <div id="model_selection">
        <label
          ><input
            type="checkbox"
            class="model-checkbox"
            value="P10827_RF_Model"
          />
          P10827_RF_Model</label
        ><br />
        <label
          ><input
            type="checkbox"
            class="model-checkbox"
            value="P10828_RF_Model"
          />
          P10828_RF_Model</label
        >
      </div>
      <button id="run_model" class="btn btn-success">Run QSAR Model</button>
      <p>Model Results:</p>
      <div class="container" id="results_container">
        <table class="table table-bordered table-striped" id="results_table">
          <thead>
            <tr id="results_table_header">
              <th>SMILES</th>
            </tr>
          </thead>
          <tbody id="results_table_body"></tbody>
        </table>
      </div>
    </div>

    <!-- SOMpredictor Section -->
    <div id="sompredictor_section" class="service-section">
      <h3>SOMpredictor Service</h3>
      <p>Additional fields for SOMpredictor service will be added later.</p>
    </div>
  </section>
</div>

<style>
  .service-section {
    margin-top: 20px;
    padding: 20px;
    background-color: #ffffff;
    border: 2px solid #29235c;
    border-radius: 8px;
    display: none;
  }

  #compound_table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  #compound_table th,
  #compound_table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: center;
  }

  #compound_table th {
    background-color: #29235c;
    color: #ffffff;
  }

  #compound_table tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }
  #compound_table tbody tr:nth-child(even) {
    background-color: #ffffff;
  }
  #compound_table tbody tr:hover {
    background-color: #e6e6fa;
    cursor: pointer;
  }

  #compound_table td:nth-child(3) {
    font-size: 0.8em;
  }

  #results_container {
    display: none;
  }
</style>

<script>
  $(document).ready(function () {
    // Fetch and populate the compound table
    $.getJSON("/get_compounds", function (data) {
      const tableBody = $("#compound_table tbody");
      tableBody.empty();
      data.forEach((option) => {
        tableBody.append(`
                  <tr>
                      <td><input type="checkbox" class="compound-checkbox" data-term="${option.Term}" data-smiles="${option.SMILES}"></td>
                      <td>${option.Term}</td>
                      <td>${option.SMILES}</td>
                  </tr>
              `);
      });
    });

    // Show or hide service sections
    $(".service-checkbox").on("change", function () {
      $("#" + $(this).val().toLowerCase() + "_section").toggle(this.checked);
    });

    // Run Model Button Click
    $("#run_model").on("click", function () {
      const selectedSMILES = $(".compound-checkbox:checked")
        .map(function () {
          return $(this).data("smiles");
        })
        .get();

      const selectedModels = $(".model-checkbox:checked")
        .map(function () {
          return $(this).val();
        })
        .get();

      if (selectedSMILES.length === 0 || selectedModels.length === 0) {
        alert("Please select at least one compound and one model.");
        return;
      }

      const payload = {
        smiles: selectedSMILES,
        models: selectedModels,
        format: "text",
      };

      fetch("https://qsprpred.cloud.vhp4safety.nl/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((response) => response.text())
        .then((data) => {
          const resultsTableHeader = $("#results_table_header");
          const resultsTableBody = $("#results_table_body");

          resultsTableHeader.find("th").not(":first").remove();
          resultsTableBody.empty();

          selectedModels.forEach((model) => {
            resultsTableHeader.append(`<th>${model}</th>`);
          });

          const results = {};
          data.split("\n").forEach((line) => {
            const match = line.match(/SMILES:\s(.+?)\s->\s(.+)/);
            if (match) {
              const smiles = match[1];
              const predictions = match[2];

              if (!results[smiles]) results[smiles] = {};

              predictions.split(",").forEach((prediction) => {
                const predictionMatch = prediction.match(
                  /prediction\s\((.+?)\):\s(.+)/
                );
                if (predictionMatch) {
                  results[smiles][predictionMatch[1]] = predictionMatch[2];
                }
              });
            }
          });

          Object.keys(results).forEach((smiles) => {
            const row = [`<td>${smiles}</td>`];
            selectedModels.forEach((model) => {
              row.push(`<td>${results[smiles][model] || "N/A"}</td>`);
            });
            resultsTableBody.append(`<tr>${row.join("")}</tr>`);
          });

          $("#results_container").show();
          $("#results_table").DataTable({
            destroy: true,
            dom: "Bfrtip",
            buttons: ["csvHtml5", "excelHtml5"],
            order: [[0, "asc"]],
          });
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred while fetching results: " + error.message);
        });
    });
  });
</script>

{% endblock %}
