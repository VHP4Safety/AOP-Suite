{% extends "base.html" %}
{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<h1>Parkinson Case Demo Workflow (Hackathon PS3)</h1>
<br />

<div class="container">
    <section>
        <h2>1. Chemicals</h2>
        <table class="table table-bordered table-striped" id="compound_table"> 
            <thead>
                <tr>
                    <th>Compound</th>
                    <th>SMILES</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically populated -->
            </tbody>
        </table>
    </section>
    
    <section>
        <h2>2. Adverse Outcome Pathways</h2>
        <button id="reset_layout" class="btn btn-secondary">Reset Layout</button>
        <div id="cy" style="height: 80vh; border: 1px solid #ccc;"></div>
        <p id="loading" style="text-align: center;">Loading AOP network...</p>
    </section>
    
    <section>
        <h2>3. Fetch Predictions</h2>
        <button id="fetch_predictions" class="btn btn-primary">Get Predictions</button>
        <table class="table table-bordered table-striped mt-3" id="predictions_table">
            <thead>
                <tr>
                    <th>SMILES</th>
                    <th>Model</th>
                    <th>Prediction Value</th>
                </tr>
            </thead>
            <tbody>
                <!-- Predictions will be inserted here -->
            </tbody>
        </table>
    </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
<script src="https://unpkg.com/popper.js/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/cytoscape-popper/cytoscape-popper.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let cy;

    function fetchAOPData() {
        return fetch("/get_aop_network")
            .then(response => response.json())
            .catch(error => {
                console.error("Error fetching AOP data:", error);
                return [];
            });
    }

    function renderAOPNetwork(elements) {
        document.getElementById("loading").style.display = "none";

        cy = cytoscape({
            container: document.getElementById("cy"),
            elements: elements,
            layout: { name: "cose", animate: true },
            style: [
                { selector: "node", style: {
                    "width": 150, "height": 150,
                    "background-color": ele => ele.data("is_mie") ? "#ccffcc" : ele.data("is_ao") ? "#ffe6e6" : "#ffff99",
                    "label": "data(label)", "text-wrap": "wrap", "text-max-width": "120px",
                    "text-valign": "center", "text-halign": "center", "color": "#000",
                    "font-size": "18px", "border-width": 2, "border-color": "#000"
                }},
                { selector: "edge", style: {
                    "curve-style": "bezier", "width": 3, "line-color": "#fcc694",
                    "opacity": 0.8, "target-arrow-shape": "triangle", "target-arrow-color": "#fcc694",
                    "label": "data(ker_label)", "text-margin-y": -15, "text-rotation": "autorotate",
                    "font-size": "20px", "font-weight": "bold", "color": "#000"
                }}
            ]
        });

        cytoscape.use(cytoscapePopper);
        
        $("#reset_layout").on("click", function () {
            cy.animate({ fit: { padding: 30 }, duration: 500 });
            cy.layout({ name: "cose", animate: true }).run();
        });
    }

    fetchAOPData().then(data => renderAOPNetwork(data));
});
</script>

<style>
.tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 14px;
    display: none;
    z-index: 10;
    max-width: 200px;
    text-align: center;
    font-weight: bold;
}
</style>

<script>
$(document).ready(function () {
    $.getJSON("/get_compounds_parkinson", function (data) {
        const tableBody = $("#compound_table tbody");
        tableBody.empty();
        data.forEach((option) => {
            const encodedSMILES = encodeURIComponent(option.SMILES);
            tableBody.append(`
                <tr>
                    <td>${option.Term}</td>
                    <td><img src="https://cdkdepict.cloud.vhp4safety.nl/depict/bot/svg?w=-1&h=-1&abbr=off&hdisp=bridgehead&showtitle=false&zoom=1.6&annotate=cip&r=0&smi=${encodedSMILES}" 
                         alt="${option.SMILES}" /></td>
                </tr>
            `);
        });
    });

    $("#fetch_predictions").on("click", function () {
        const smilesList = [];

        $("#compound_table tbody tr").each(function () {
            const imgElement = $(this).find("td:eq(1) img");
            if (imgElement.length) {
                const smiles = imgElement.attr("alt").trim();
                if (smiles) {
                    smilesList.push(smiles);
                }
            }
        });

        console.log("Extracted SMILES List:", smilesList);

        const requestData = {
            smiles: smilesList,
            models: [
                "P10827_RF_Model", "P10828_RF_Model", "P31644_RF_Model",
                "P41594_Allosteric_RF_Model", "P41594_Orthosteric_RF_Model",
                "Q13224_RF_Model", "Q13255_Allosteric_RF_Model"
            ],
            metadata: {}, threshold: 6.5
        };

        $.ajax({
            url: "/get_predictions",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(requestData),
            success: function (response) {
                console.log("API Response:", response);
                const tableBody = $("#predictions_table tbody");
                tableBody.empty();

                if (Array.isArray(response)) {
                    response.forEach(prediction => {
                        Object.entries(prediction).forEach(([model, value]) => {
                            if (model !== "smiles") {
                                tableBody.append(`
                                    <tr>
                                        <td>${prediction.smiles || "N/A"}</td>
                                        <td>${model}</td>
                                        <td>${value}</td>
                                    </tr>
                                `);
                            }
                        });
                    });
                } else {
                    console.error("Unexpected API response format:", response);
                    alert("Error: Unexpected response format from server.");
                }
            },
            error: function () {
                alert("Error fetching predictions.");
            }
        });
    });
});
</script>

{% endblock %}
