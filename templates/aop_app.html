{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/aop_app.css') }}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<div class="dashboard-container" data-mies="{{ mie_query if mie_query is defined else '' }}"
    data-qid="{{ qid if qid is defined else '' }}" data-qid-wd="{{ qid_wd if qid_wd is defined else '' }}"
    data-title="{{ title if title is defined else 'AOP Network Builder' }}" id="compound-container">
    <!-- Top Navigation Bar -->
    <header class="top-nav">
        <div class="nav-section">
            <button id="toggle-left-sidebar" class="sidebar-toggle btn-secondary">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-project-diagram"></i> {{ title if title is defined else 'AOP Network Builder' }}</h1>
        </div>
        <div class="nav-controls">
            <div class="control-group">
                <label>Font Size:</label>
                <input type="range" id="font-size-slider" min="0.1" max="1" step=".1" value="0.5" class="slider">
            </div>
            <button id="save_network" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Network
            </button>
            <button id="load_network" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Load Network
            </button>
            <button id="toggle-right-sidebar" class="sidebar-toggle btn-secondary">
                <i class="fas fa-table"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Left Sidebar -->
        <aside class="left-sidebar" id="left-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cog"></i> Controls</h3>
                <button class="sidebar-close" data-target="left-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>


            <!-- Manual Data Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-plus-circle"></i> Add Data Manually</h3>
                </div>
                <div class="panel-content">
                    <!-- Add Nodes Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="add-nodes-content">
                            <h4><i class="fas fa-circle"></i> Add Nodes</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="add-nodes-content">
                            <div class="node-controls">
                                <div class="form-group">
                                    <label for="node-type">Node Type:</label>
                                    <select id="node-type" class="form-control">
                                        <option value="ke">Key Event</option>
                                        <option value="chemical">Chemical</option>
                                        <option value="uniprot">UniProt</option>
                                        <option value="ensembl">Ensembl</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="node-label">Node Labels:</label>
                                    <input type="text" id="node-label" class="form-control"
                                        placeholder="Enter node labels (space or comma separated)">
                                    <small class="form-text">Examples: "Gene1 Gene2" or "Protein A, Protein B, Protein
                                        C"</small>
                                </div>
                                <div class="form-group">
                                    <label for="node-id">Node IDs (optional):</label>
                                    <input type="text" id="node-id" class="form-control"
                                        placeholder="Auto-generated if empty (space or comma separated)">
                                    <small class="form-text">If provided, must match the number of labels</small>
                                </div>
                                <button id="add-node" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Add Node
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Add Edges Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="add-edges-content">
                            <h4><i class="fas fa-link"></i> Add Edges</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="add-edges-content">
                            <div class="connection-controls">
                                <div class="form-group">
                                    <label for="source-node">Source Node:</label>
                                    <div class="searchable-dropdown">
                                        <input type="text" id="source-node-search" class="form-control dropdown-search"
                                            placeholder="Search source nodes...">
                                        <select id="source-node" class="form-control searchable-select" size="5">
                                            <option value="">Select source...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="target-node">Target Node:</label>
                                    <div class="searchable-dropdown">
                                        <input type="text" id="target-node-search" class="form-control dropdown-search"
                                            placeholder="Search target nodes...">
                                        <select id="target-node" class="form-control searchable-select" size="5">
                                            <option value="">Select target...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="edge-type">Connection Type:</label>
                                    <select id="edge-type" class="form-control">
                                        <option value="ker">Key Event Relationship</option>
                                        <option value="interaction">Interaction</option>
                                        <option value="part_of">Part Of</option>
                                        <option value="translates_to">Translates To</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edge-label">Connection Label (optional):</label>
                                    <input type="text" id="edge-label" class="form-control"
                                        placeholder="Enter connection label">
                                </div>
                                <button id="add-connection" class="btn btn-success">
                                    <i class="fas fa-link"></i> Add Edge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AOP Network Data Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-network-wired"></i> Populate network</h3>
                </div>
                <div class="panel-content">
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="aop-network-content">
                            <h4><i class="fas fa-plus-circle"></i> Query AOP WIKI RDF</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="aop-network-content">
                            <div class="aop-network-controls">
                                <div class="form-group">
                                    <label for="query-type">Query Type:</label>
                                    <select id="query-type" class="form-control">
                                        <option value="mie">Add by MIE</option>
                                        <option value="aop">Add by AOP</option>
                                        <option value="ke_upstream">Add by Upstream KE</option>
                                        <option value="ke_downstream">Add by Downstream KE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="query-values">AOP Identifiers or Names:</label>
                                    <textarea id="query-values" class="form-control" rows="4"
                                        placeholder="Search by AOP name or enter identifiers (one per line)&#10;Examples:&#10;liver fibrosis&#10;1&#10;aop:2&#10;https://identifiers.org/aop/3"></textarea>
                                    <small class="form-text">
                                        Enter one AOP per line:<br>
                                        • Search by name: "liver fibrosis", "reproductive dysfunction"<br>
                                        • Or enter IDs: 1, aop:1, https://identifiers.org/aop/1<br>
                                        • Mix both approaches as needed
                                    </small>
                                </div>
                                <button id="add-aop-data" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add to Network
                                </button>
                                <div id="aop-data-status" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="go-processes-content">
                            <h4><i class="fas fa-project-diagram"></i> GO Biological Processes</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="go-processes-content">
                            <div class="go-processes-controls">
                                <div class="form-group">
                                </div>
                                <div class="button-group">
                                    <button id="toggle_go_processes" class="btn btn-primary">
                                        <i class="fas fa-hexagon"></i> Show GO Processes
                                    </button>
                                    <button id="show_go_hierarchy" class="btn btn-secondary">
                                        <i class="fas fa-sitemap"></i> Show GO Hierarchy
                                    </button>
                                </div>
                                <div class="form-group">
                                    <small class="form-text text-muted">
                                        • <strong>Show GO Processes:</strong> Add direct biological processes from current Key Events<br>
                                        • <strong>Show GO Hierarchy:</strong> Include parent-child relationships in the hierarchy
                                    </small>
                                </div>
                                <div id="go-processes-status" class="mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- OpenTargets Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="opentargets-content">
                            <h4><i class="fas fa-bullseye"></i> OpenTargets</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="opentargets-content">
                            <div class="opentargets-controls">
                                <button id="query_opentargets" class="btn btn-secondary w-100">
                                    <i class="fas fa-bullseye"></i> Query OpenTargets
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bgee Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" data-target="bgee-content">
                            <h4><i class="fas fa-dna"></i> Bgee Expression</h4>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="collapsible-content" id="bgee-content">
                            <div class="bgee-controls">
                                <button id="query_bgee" class="btn btn-secondary w-100">
                                    <i class="fas fa-dna"></i> Query Bgee
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QSPR Predictions Controls -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-flask"></i> QSPR Predictions</h3>
                </div>
                <div class="panel-content">
                    <div class="form-group">
                        <label for="threshold_pchembl">pChEMBL Threshold:</label>
                        <input type="number" step="0.1" class="form-control" id="threshold_pchembl" value="6.5">
                        <small class="form-text">Activity of 10<sup id="activity_display">-6.5</sup> M</small>
                    </div>
                    <button id="fetch_predictions" type="button" class="btn btn-primary w-100">
                        <i class="fas fa-flask"></i> Fetch Predictions
                    </button>
                </div>
            </div>

        </aside>

        <!-- Center Network Area -->
        <main class="network-area">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-project-diagram"></i> Network Visualization</h3>
                    <div class="network-controls">
                        <button id="see_genes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-dna"></i> See Genes
                        </button>
                        <button id="toggle_bounding_boxes" class="btn btn-sm btn-secondary">
                            <i class="fas fa-object-group"></i> Group by AOP
                        </button>
                        <button id="reset_layout" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync"></i> Reset Layout
                        </button>
                        <button id="download_network" class="btn btn-sm btn-secondary">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="panel-content network-container">
                    <div class="loading-overlay">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-3x"></i>
                            <p>Loading network...</p>
                        </div>
                    </div>
                    <div id="cy"></div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar" id="right-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-table"></i> Data Tables</h3>
                <button class="sidebar-close" data-target="right-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Compounds Table -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-flask"></i> Compounds</h3>
                    <div class="compound-controls">
                        <button id="toggle_compounds" class="btn btn-sm btn-secondary">
                            <i class="fas fa-flask"></i> Toggle Compounds
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="compound-selection-hint">
                        <p>Click compound rows to show their pathways in the network</p>
                    </div>
                    <div class="table-wrapper">
                        <div id="loading_compound" class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading compounds...
                        </div>
                        <table id="compound_table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Compound</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Genes Table - Always visible -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-dna"></i> Genes</h3>
                </div>
                <div class="panel-content">
                    <div class="table-wrapper">
                        <table id="gene_table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Gene</th>
                                    <th>Expression</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AOP Relationships Table - Always visible -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-network-wired"></i> AOP Relationships</h3>
                </div>
                <div class="panel-content">
                    <div id="loading_aop_table" class="loading-indicator" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Loading AOP data...
                    </div>
                    <div id="aop-table-container" class="table-wrapper">
                        <!-- Filter and table will be dynamically inserted here by aop_table_enhancements.js -->
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Table Mapping Modal -->
<div class="modal fade" id="table-mapping-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Map Table to Network</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Node Creation</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="create-nodes-checkbox">
                            <label class="form-check-label" for="create-nodes-checkbox">Create nodes from table</label>
                        </div>
                        <div class="form-group">
                            <label for="node-type-select">Node Type:</label>
                            <select id="node-type-select" class="form-control">
                                <option value="ke">Key Event</option>
                                <option value="chemical">Chemical</option>
                                <option value="uniprot">UniProt</option>
                                <option value="ensembl">Ensembl</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="node-id-column">ID Column:</label>
                            <select id="node-id-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="node-label-column">Label Column:</label>
                            <select id="node-label-column" class="form-control"></select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Edge Creation</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="create-edges-checkbox">
                            <label class="form-check-label" for="create-edges-checkbox">Create edges from table</label>
                        </div>
                        <div class="form-group">
                            <label for="edge-type-select">Edge Type:</label>
                            <select id="edge-type-select" class="form-control">
                                <option value="ker">Key Event Relationship</option>
                                <option value="interaction">Interaction</option>
                                <option value="part_of">Part Of</option>
                                <option value="translates_to">Translates To</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edge-source-column">Source Column:</label>
                            <select id="edge-source-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="edge-target-column">Target Column:</label>
                            <select id="edge-target-column" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="edge-label-column">Label Column:</label>
                            <select id="edge-label-column" class="form-control"></select>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Property Columns</h6>
                        <div id="property-columns">
                            <!-- Dynamically populated checkboxes -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-mapping-btn">Apply Mapping</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let compound_data = {};
    let compoundMapping = {};
    let modelToProteinInfo = {};
    let fetched_preds = false;
    let genesVisible = false;
    let boundingBoxesVisible = false;
    let compoundsVisible = false;

    // Make sure cy is available globally from the start
    window.cy = null;

    // Update activity display
    function updateActivity() {
        const value = document.getElementById('threshold_pchembl').value;
        const activityDisplay = document.getElementById('activity_display');
        if (activityDisplay) {
            activityDisplay.textContent = `-${value}`;
        }
    }

    // Sidebar collapse functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize threshold input event listener
        const thresholdInput = document.getElementById('threshold_pchembl');
        if (thresholdInput) {
            thresholdInput.addEventListener('input', updateActivity);
            // Initialize display on load
            updateActivity();
        }

        // Toggle buttons in nav
        document.getElementById('toggle-left-sidebar')?.addEventListener('click', function () {
            toggleSidebar('left-sidebar');
        });

        document.getElementById('toggle-right-sidebar')?.addEventListener('click', function () {
            toggleSidebar('right-sidebar');
        });

        // Close buttons in sidebars
        document.querySelectorAll('.sidebar-close').forEach(button => {
            button.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                toggleSidebar(targetId);
            });
        });

        // Collapsible sections functionality
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const content = document.getElementById(targetId);
                const icon = this.querySelector('.collapse-icon');
                
                if (content && icon) {
                    // Toggle the content visibility
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        content.style.display = 'none';
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        });

        // Initialize all collapsible content as hidden
        document.querySelectorAll('.collapsible-content').forEach(content => {
            content.style.display = 'none';
        });
    });

    function toggleSidebar(sidebarId) {
        const sidebar = document.getElementById(sidebarId);
        if (!sidebar) return;

        sidebar.classList.toggle('collapsed');

        // Trigger resize event for Cytoscape to adjust
        setTimeout(() => {
            if (window.cy) {
                window.cy.resize();
                if (window.positionNodes) {
                    window.positionNodes(window.cy);
                }
            }
        }, 300);
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.js"></script>

<script src="/static/js/aop_app/aopName.js"></script>
<script src="/static/js/aop_app/aop_elements.js"></script>
<script src="/static/js/aop_app/aop_styles.js"></script>
<script src="/static/js/aop_app/qsprpred.js"></script>
<script src="/static/js/aop_app/compound.js"></script>
<script src="/static/js/aop_app/gene.js"></script>
<script src="/static/js/aop_app/bdf.js"></script>
<script src="/static/js/aop_app/network_persistence.js"></script>
<script src="/static/js/aop_app/manual_controls.js"></script>
<script src="/static/js/aop_app/custom_tables.js"></script>
<script src="/static/js/aop_app/table_aop.js"></script>
<script src="/static/js/aop_app/aop_network_data.js"></script>
<script src="/static/js/aop_app/aop_table_enhancements.js"></script>

{% endblock %}